generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id                  String      @id @default(cuid())
    email               String      @unique
    password            String
    role                UserRole    @default(CLIENT)
    defaultPassword     String
    status              String? // e.g. 'Active', 'Inactive', 'Pending'
    // Name & contact
    firstName           String
    middleName          String?
    lastName            String
    gender              String?
    dob                 DateTime?
    phone               String?
    unitApartmentNumber String?
    address             String?
    emergencyContact    String?
    employmentType      String? // e.g. 'Full-time', 'Part-time', 'Contractor'
    kinName             String? // Next of kin name
    kinPhone            String? // Next of kin phone number
    kinEmail            String? // Next of kin email address
    kinRelation         String? // Next of kin relation (e.g. 'Parent', 'Sibling', 'Friend') 
    // Admin-specific
    adminLevel          AdminLevel? // Only for ADMIN role
    permissions         String[] // Only for ADMIN role

    // Coordinator-specific
    department String? // Only for COORDINATOR role
    region     String? // Only for COORDINATOR role

    // Client-specific
    clientId String? // Only for CLIENT role
    company  String? // Only for CLIENT role

    // Common optional fields
    profileImage         String?
    profileImagePublicId String? // Cloudinary public ID for the profile image
    languageSpoken       String?
    isVerified           Boolean   @default(false)
    verificationToken    String?
    resetPasswordToken   String?
    resetPasswordExpires DateTime?
    licenseNumber        String?
    specialization       String?
    joinedDate           DateTime  @default(now())
    lastLogin            DateTime?
    twoFactorEnabled     Boolean   @default(false)
    emailNotifications   Boolean   @default(true)
    smsNotifications     Boolean   @default(true)
    isFirstLogin         Boolean   @default(true)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    isActive            Boolean @default(true)
    sendOnboardingEmail Boolean @default(true)
    inviteStaffViaSMS   Boolean @default(false)

    // Relations
    refreshTokens   RefreshToken[]
    documents       Document[] // one-to-many
    Client          Client?        @relation(fields: [clientId], references: [id])
    assignedClients Client[]       @relation("UserAssignedClients")
    FormTemplate    FormTemplate[]
    FilledForm      FilledForm[]
    notification    Notification[]
    Activity        Activity[]

    @@map("users")
}

// Enum for user roles
enum UserRole {
    ADMIN
    COORDINATOR
    CLIENT
}

// Enum for admin levels
enum AdminLevel {
    SUPER
    STANDARD
}

// RefreshToken model for JWT refresh tokens
model RefreshToken {
    id        String   @id @default(cuid())
    token     String   @unique
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    isRevoked Boolean  @default(false)
    ipAddress String?
    userAgent String?

    @@map("refresh_tokens")
}

model Client {
    id             String    @id @default(cuid())
    title          String?
    firstName      String
    middleName     String?
    lastName       String
    phone          String?
    email          String?   @unique
    address        String?
    gender         String?
    dob            DateTime?
    maritalStatus  String?
    religion       String?
    nationality    String?
    languageSpoken String?
    status         String? // e.g. 'Active', 'Inactive', 'Pending'

    profilePictureUrl    String?
    profileImagePublicId String? // Cloudinary public ID for the profile image

    generalInfo     String?
    usefulInfo      String?
    needToKnowInfo  String?
    ndisNumber      String?
    agedCareId      String?
    referenceNumber String?
    poNumber        String?
    customField     String?

    clientType    String?
    smsReminders  Boolean @default(false)
    invoiceTravel Boolean @default(false)

    assignedUsers User[]     @relation("UserAssignedClients")
    // Arrays (stored as separate tables/relations)
    contacts      Contact[] // one-to-many
    teams         Team[] // many-to-many or one-to-many
    documents     Document[] // one-to-many
    forms         Form[] // one-to-many

    createdAt  DateTime     @default(now())
    updatedAt  DateTime     @updatedAt
    User       User[]
    FilledForm FilledForm[]
}

model Team {
    id      String   @id @default(cuid())
    name    String
    clients Client[] // many-to-many relation if needed
}

model Document {
    id            String  @id @default(cuid())
    name          String
    url           String // This should be the S3 public or signed URL
    imagePublicId String? // Cloudinary public ID for the profile image

    type       String? // Optional: e.g. 'PDF', 'IMAGE', 'DOCX', etc.
    uploadedAt DateTime @default(now())
    client     Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
    user       User?    @relation(fields: [userId], references: [id])
    userId     String?
    clientId   String
}

model Form {
    id       String @id @default(cuid())
    title    String
    data     Json
    client   Client @relation(fields: [clientId], references: [id])
    clientId String
}

model Contact {
    id            String  @id @default(cuid())
    title         String?
    firstName     String
    lastName      String
    email         String?
    contactNumber String?
    address       String?

    relation        String? // e.g. 'Parent', 'Guardian', 'Friend'
    companyName     String?
    purchaseOrder   String?
    referenceNumber String?
    isPrimary       Boolean @default(false)
    isBilling       Boolean @default(false)
    client          Client  @relation(fields: [clientId], references: [id])
    clientId        String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Blog {
    id            String  @id @default(cuid())
    title         String
    author        String
    type          String
    status        String
    excerpt       String
    content       String
    featuredImage String?
    imagePublicId String? // Cloudinary public ID for the profile image

    publishDate     DateTime?
    tags            String[] // Stored as string array (PostgreSQL only)
    metaTitle       String
    metaDescription String
    isFeatured      Boolean   @default(false)
    slug            String    @unique
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
}

model Message {
    id               String   @id @default(cuid())
    name             String
    email            String
    phone            String
    service          String
    message          String
    preferredContact String? // e.g. 'Email', 'Phone', 'SMS'
    isRead           Boolean  @default(false)
    isStarred        Boolean  @default(false)
    isArchived       Boolean  @default(false)
    priority         String? // e.g. 'Low', 'Medium', 'High'
    receivedAt       DateTime @default(now())
    category         String? // e.g. 'Inquiry', 'Support', 'Feedback'
}

model FormTemplate {
    id          String   @id @default(cuid())
    name        String
    description String?
    fields      Json // Form structure (e.g., array of elements)
    user        User?    @relation(fields: [userId], references: [id])
    userId      String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    filledForms FilledForm[] // <-- new relation
}

model FilledForm {
    id             String       @id @default(cuid())
    formTemplate   FormTemplate @relation(fields: [formTemplateId], references: [id])
    formTemplateId String

    client   Client @relation(fields: [clientId], references: [id])
    clientId String

    user   User?   @relation(fields: [userId], references: [id])
    userId String?

    responses   Json // The actual filled-in answers
    completedAt DateTime @default(now())
    notes       String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// model Notification {
//     id         String   @id @default(cuid())
//     user       User     @relation(fields: [userId], references: [id])
//     userId     String
//     message    String
//     readStatus Boolean  @default(false)
//     type       String // e.g. "task", "reminder", "chat"
//     createdAt  DateTime @default(now())
//     // Optionally link to a client, or other models
//     // clientId   Int? // Optional: reference client involved with notification
//     // client     Client?  @relation(fields: [clientId], references: [id])
// }

model Notification {
    id     String @id @default(uuid())
    user   User   @relation(fields: [userId], references: [id])
    userId String

    title   String?
    message String
    type    String

    readStatus Boolean  @default(false)
    createdAt  DateTime @default(now())

    actionUrl String? // Optional URL the notification points to
    avatar    String? // Optional avatar image URL or path
    clientId  String? // Optional: reference client involved with notification
    metadata  Json? // Stores appointmentTime, clientName, etc.

    // Uncomment if you want to link to a related appointment/message/client, etc.
    // appointmentId Int?
    // messageId     Int?
    // clientId      Int?
}

enum ActivityType {
    USER_CREATED
    CLIENT_ADDED
    MESSAGE_RECEIVED
    APPOINTMENT_SCHEDULED
    SYSTEM_ALERT
    // extend as needed
}

enum ActivityStatus {
    SUCCESS
    INFO
    WARNING
    ERROR
    // extend as needed
}

model Activity {
    id          String       @id @default(cuid())
    type        ActivityType
    description String
    user        User?        @relation(fields: [userId], references: [id])

    userId   String? // This must be present!
    userRole UserRole? // Stores user's enum role at creation
    userName String?

    createdAt DateTime       @default(now())
    status    ActivityStatus

    // New fields for clickable linking
    targetType String? // e.g., "user", "invoice", "project"
    targetId   String? // ID of the entity (kept as String for flexibility)

    // Optional for extra structured data
    meta Json?
}
